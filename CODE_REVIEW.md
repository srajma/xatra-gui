| # | Issue | File | Lines | Severity | Fix |
|---|-------|------|-------|----------|-----|
| 1 | exec() runs in main process for territory catalog | main.py | 1680–1715 | Critical | Added `_extract_territory_index()` helper that uses `ast.walk` + `ast.literal_eval` to safely extract `__TERRITORY_INDEX__` values without executing user code. Rewrote `_get_territory_catalog()` to use only AST analysis — all `exec()` calls removed from the main process. |
| 2 | Path traversal via dataframe CSV path (pd.read_csv(val) on user input) | main.py | 3093–3094 | Critical | Removed the file-path branch entirely. Always passes value through `io.StringIO(val)` so `pd.read_csv` treats it as inline content, never as a filesystem path. |
| 3 | Hardcoded "admin" password seeded at startup, bypassing 8-char minimum | main.py | 300 | Critical | Admin password now comes from `os.environ.get("ADMIN_PASSWORD")` or a freshly generated `secrets.token_urlsafe(16)`. Password is only printed to the console when the account is first created (uses `INSERT OR IGNORE` + checks `rowcount`). |
| 4 | postMessage(..., '*') — wildcard origin on all iframe messages | App.jsx | 977, 1244, 1258, 1515 | Critical | Added origin guard at the top of `handleMessage`: `if (event.origin !== 'null' && event.origin !== window.location.origin) return;`. The `'null'` string is the correct origin for srcdoc iframes; all other unrecognised origins are dropped. |
| 5 | /stop endpoint has no authentication — anyone can kill all renders | main.py | 2405 | High | Added auth check: resolves session user and reads guest cookie; raises HTTP 401 if neither is present. Authenticated users (logged-in or guest with cookie) can stop their own renders. |
| 6 | Anonymous user can write to any guest artifact (no guest cookie check) | main.py | 1786 | High | `_require_write_identity` now reads and validates the guest cookie (`GUEST_COOKIE`). If the request has no session and no valid guest cookie it raises HTTP 401, preventing unauthenticated writes to guest-owned artifacts. |
| 7 | All artifact draft (alpha) content is publicly readable, no access control | main.py | 2267 | High | `hub_get_artifact_version` now checks ownership for the `alpha` version: if the requester is not the artifact owner (matched by user id or guest id), a 403 Forbidden is returned. Published versions remain public. |
| 8 | Login deletes all sessions across all devices | main.py | 1828 | High | Removed the `DELETE FROM hub_sessions WHERE user_id = ?` statement from `auth_login`. A new session row is inserted without invalidating existing sessions on other devices. |
| 9 | No rate limiting on /auth/login, /auth/signup, /auth/me/password | main.py | 1791 | High | Added in-memory sliding-window rate limiter (`_check_rate_limit`, `_rate_limit_store`, `_rate_limit_lock`). Applied: signup 5/hr per IP, login 10/5 min per IP, password-change 5/5 min per IP. Returns HTTP 429 when exceeded. |
| 10 | Hard-coded http://localhost:8088 in frontend components (bypasses API_BASE) | TerritoryBuilder, LayerItem, App | 789, 811, 30, 1222, 2287 | High | Created `frontend/src/config.js` exporting `API_BASE`. Updated `App.jsx`, `TerritoryBuilder.jsx`, `LayerItem.jsx`, and `AutocompleteInput.jsx` to import and use `API_BASE` for all backend fetch calls. |
| 11 | _session_expiry_iso() returns current time, not expiry (dead but broken) | main.py | 854 | Medium | Fixed `_session_expiry_iso()` to return `datetime.now(timezone.utc) + timedelta(days=SESSION_TTL_DAYS)` (uses the `SESSION_TTL_DAYS` constant and produces a future timestamp). |
| 12 | Race condition: process registered after lock released | main.py | 3152–3163 | Medium | Merged the two consecutive `with process_lock:` blocks into one. `p.start()` now runs inside the same lock acquisition as `current_processes[task_type] = p`, eliminating the window where the process could start but not yet be registered. |
| 13 | Full Python tracebacks returned to clients | main.py | 3134 | Medium | Subprocess exception handler now prints the full traceback to `sys.stderr` server-side via `traceback.format_exc()`, but only returns `{"error": str(e)}` to the client — no internal stack frames exposed. |
| 14 | useEffect stale closures on lastMapClick handler (missing deps) | TerritoryBuilder.jsx | 394–410 | Medium | Added all referenced variables to the `useEffect` dependency arrays in `TerritoryBuilder.jsx` (`lastMapClick`, `pickingIndex`, `parts`, `draftPoints`, `onChange`) and in `LayerItem.jsx` (`lastMapClick`, `isPicking`, `element.type`, `index`, `updateElement`, `draftPoints`, `setActivePicker`, `setDraftPoints`). |
| 15 | setTimeout IDs not stored → can't clear on unmount | Builder.jsx, LayerItem.jsx | 76, 47 | Medium | `Builder.jsx`: stores all focus-delay timeout IDs in `focusTimeoutsRef` (a ref array), clears them in the `useEffect` cleanup. `LayerItem.jsx`: stores the picker-cancel timeout ID in `pickerTimeoutRef`, clears it in cleanup and before each new timeout. |
| 16 | pyVal corrupts strings containing the word "null" | App.jsx | 2027 | Medium | Replaced the regex-based `pyVal` with a recursive `jsonToPy(val)` helper that type-switches on `null`, boolean, number, string, array, and object, mapping each to the correct Python literal. `pyVal` now delegates to `jsonToPy` for non-primitive values. |
| 17 | handleSaveTerritoryToLibrary injects unsanitized label into Python code | App.jsx | 2001 | Medium | The territory variable name is now built as `safeName = (label).replace(/\s+/g,'_').replace(/[^a-zA-Z0-9_]/g,'').replace(/^[0-9]+/,'') \|\| 'territory'` before being interpolated into the generated Python. |
| 18 | GADM globals mutated without lock (thread race) | main.py | 529–640 | Low | Added `_gadm_lock = threading.Lock()`. All mutations of `gadm_index`, `country_to_gids`, and `gid_to_names` are now guarded by `with _gadm_lock:` in `build_gadm_index()`, `rebuild_country_indexes()`, and the startup loading paths. |
| 19 | LIKE search wildcards (%, _) not escaped in user queries | main.py | 2038 | Low | Added LIKE-wildcard escaping before building the pattern: `escaped = term.replace('\\','\\\\').replace('%','\\%').replace('_','\\_')`. All LIKE clauses in the explore endpoint now include `ESCAPE '\\'`. |
| 20 | No artifact/content size limits | main.py | 2227 | Low | Added `MAX_ARTIFACT_BYTES = 10 * 1024 * 1024` constant. Both the save (`PUT /hub/...`) and publish (`POST /hub/.../publish`) endpoints check `len(content.encode("utf-8")) > MAX_ARTIFACT_BYTES` and return HTTP 413 if exceeded. |
