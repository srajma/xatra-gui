| # | Issue | File | Lines | Severity | Fix |
|---|-------|------|-------|----------|-----|
| 1 | `POST /hub/users/ensure` has no authentication or rate limiting — any client can pre-create user records, bypass reserved-username checks, or enumerate valid usernames | main.py | 2217–2225 | Critical | Require a valid session (logged-in or guest) before creating a user record. Add rate limiting (e.g. 10 requests/hr per IP) using the existing `_check_rate_limit` infrastructure. |
| 4 | LIKE wildcard injection (`%`, `_`) in user search queries is not escaped in `/users`, `/users/{username}`, and `/hub/registry` — allows arbitrary pattern matching against the database (unlike `/explore` which was fixed in CODE_REVIEW #19) | main.py | 2100, 2140–2142, 2371–2373 | High | Apply the same escaping already used in `/explore`: replace `\` → `\\`, `%` → `\%`, `_` → `\_` in every search term before building the LIKE pattern, and append `ESCAPE '\\'` to every LIKE clause in these three endpoints. |
| 5 | `PUT /draft/current` has no content size limit — an authenticated (or guest) user can store arbitrarily large JSON, exhausting disk space | main.py | 2170–2197 | High | Add the same `MAX_ARTIFACT_BYTES` check used in the artifact save and publish endpoints: reject with HTTP 413 if `len(project_json.encode("utf-8")) > MAX_ARTIFACT_BYTES`. |
| 6 | Raw polygon value from the territory builder is interpolated directly into generated Python code — a crafted value such as `[]) + __import__('os').system('id') + polygon([` produces an arbitrary code injection in the subprocess | App.jsx | 1967 | High | Validate and sanitize `part.value` before interpolation: parse it as JSON with `JSON.parse`, round-trip all coordinates through `Number()`, and only emit the sanitized numeric array. Reject or escape any value that does not parse as a valid coordinate array. |
| 7 | `postMessage` to srcdoc iframes still uses `'*'` as the target origin in four call sites — any cross-origin page that can frame the app can intercept or spoof these messages (partial fix from CODE_REVIEW #4 only added a receive-side guard, not a send-side origin) | App.jsx | 976, 1245, 1259, 1516 | Medium | Replace `postMessage(msg, '*')` with `postMessage(msg, 'null')` at all four call sites. The `'null'` string is the correct serialized origin for `srcdoc` iframes and prevents delivery to any other origin. |
| 8 | `getattr(plt.cm, cmap_type, None)` resolves a user-controlled string as an attribute on the matplotlib colormap module — an attacker can access arbitrary `plt.cm` attributes (e.g. `__class__`, `__subclasses__`) via the `data_colormap.type` field | main.py | 2893 | Medium | Maintain an explicit allowlist of valid colormap names (e.g. `VALID_CMAPS = {"LinearSegmented", "viridis", "plasma", ...}`) and reject any `cmap_type` not in that set before calling `getattr`. |
| 9 | `predefinedVariables` regex `/^(\w+)\s*=/gm` matches inside comments (`# VAR = ...`) and string literals — spurious variable names appear in the territory autocomplete dropdown | TerritoryBuilder.jsx | 829–839 | Medium | Strip comment lines (lines where the first non-whitespace character is `#`) and string literal blocks before running the regex, or use a more precise heuristic (e.g. only match lines where the identifier starts at column 0 and is not preceded by `#`). |
| 10 | Auto-save `useEffect` does not list `mapName` in its dependency array — renaming a map without any other state change never persists the new name to the draft | App.jsx | 2342 | Low | Add `mapName` to the dependency array of the auto-save `useEffect` so that a rename alone triggers a draft write. |
| 11 | GADM index is written to the relative path `"gadm_index.json"` — when the server is started from a directory other than the project root the file is created in the wrong location and the pre-built index is never found on the next startup | main.py | 652 | Low | Derive the path relative to `__file__`: `os.path.join(os.path.dirname(os.path.abspath(__file__)), "gadm_index.json")`. Apply the same fix to every other read/write of this path. |
| 12 | `downloadFile` calls `URL.createObjectURL()` but never calls the matching `URL.revokeObjectURL()` — each download leaks a Blob URL that is retained for the lifetime of the page | App.jsx | 1653–1659 | Low | After the programmatic click, schedule `URL.revokeObjectURL(url)` in a `setTimeout(..., 0)` (or in the `click` event handler) so the object URL is released once the download has started. |
